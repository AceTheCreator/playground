<div id="App">
  {{> topbar }}
  {{> left-pane app='#App' }}
  {{> right-pane app='#App' }}
</div>

<script>
  window.addEventListener('load', () => {
    const state = {
      code: '',
      template: 'html',
    };

    function generate() {
      superagent
        .post(`/${state.template}/generate`)
        .send(state.code)
        .set('Accept', 'text/plain')
        .set('Content-Type', 'text/plain')
        .end((err, res) => {
          if (err) {
            document.getElementById('errors').innerHTML = res.body.errors ? JSON.stringify(res.body.errors, null, 2) : res.body.message;
            document.querySelector('.errors-wrapper').classList.remove('errors-wrapper--hidden');
            return;
          }

          var result = res.text;

          document.querySelector('.errors-wrapper').classList.add('errors-wrapper--hidden');
          document.getElementById('result').contentWindow.postMessage(result, '*');

          try {
            localStorage.setItem('doc-v2', state.code);
            localStorage.setItem('result-v2', result);
          } catch (e) {
            console.error('Could not store result in localStorage.');
            console.error(e);
          }
        });
    }

    document.getElementById('App').addEventListener('templateChange', (e) => {
      state.template = e.detail;
      generate();
    });

    document.getElementById('App').addEventListener('onCodeChange', (e) => {
      state.code = e.detail;
      generate();
    });
  });
</script>
